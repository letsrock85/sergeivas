# Сергеивас.com - Статус Проекта

## Текущий Stack (Февраль 2026)

```
- Next.js:        16.1.4      ✅ Обновлено
- React:          19.2.3      ✅ Обновлено
- TypeScript:     5.9.3       ✅ Обновлено
- Sanity CMS:     5.5.0       ✅ Работает
- next-sanity:    12.0.14     ✅ Обновлено
- TailwindCSS:    3.3.3       ✅ Текущая версия (v4 в планах)
- styled-components: 6.1.8    ✅ Совместимо
```

---

## Sanity Webhook Revalidation

### Статус: ✅ НАСТРОЕНО И РАСШИРЕНО (2026-02-09)

### Как работает
1. Публикуешь контент в Sanity Studio
2. Sanity отправляет webhook на `/api/revalidate-path`
3. Next.js инвалидирует кеш для нужных страниц (по тегам и путям)
4. При следующем посещении страница обновляется с новым контентом

### Поддерживаемые типы контента
| Sanity _type | Теги кеша     | Обновляемые страницы       |
|-------------|---------------|---------------------------|
| Post        | Post          | /blog, /blog/[slug]       |
| project     | project       | /projects, /projects/[slug]|
| author      | Post          | /                         |
| profile     | profile       | /, /about                 |
| job         | job           | /                         |
| heroe       | heroe         | /about                    |

### Настройки в Sanity (manage.sanity.io → API → Webhooks)

**URL:**
```
https://www.sergeivas.com/api/revalidate-path
```

**Filter (GROQ):**
```groq
_type in ["Post", "project", "author", "profile", "job", "heroe"]
```

**Projection (GROQ):**
```groq
{_type, "slug": slug.current}
```

**Другие настройки:**
- HTTP Method: POST
- Trigger on: Create ✅, Update ✅, Delete ✅
- Enable webhook: ✅
- Secret: `your-ass-1` (тот же что в Vercel `SANITY_HOOK_SECRET`)

### Vercel Environment Variables
```
SANITY_HOOK_SECRET=your-ass-1
```

### API Endpoint
Файл: `/app/api/revalidate-path/route.ts`
- Использует `@sanity/webhook` для проверки подписи
- TAG_MAP: маппинг _type → теги кеша (должны совпадать с тегами в sanityFetch)
- PATH_MAP: маппинг _type → пути страниц для revalidatePath
- Вызывает `revalidateTag()` для инвалидации Data Cache
- Вызывает `revalidatePath()` для инвалидации Route Cache

### Важные моменты

**Next.js 16 Breaking Changes:**
- `params` теперь асинхронный: `const { post } = await params`
- `revalidateTag(tag, 'default')` требует второй аргумент

**Sanity _type:**
- В базе документы имеют `_type: "Post"` (не "blogPost")
- Filter должен использовать `"Post"`, не `"blogPost"`

**Теги кеша:**
- Теги в TAG_MAP должны точно совпадать с тегами в `sanityFetch({ tags: [...] })`
- Например: `project` (lowercase), не `Project` (uppercase)

**Обработка отсутствующих данных:**
- `urlFor()` падает на `undefined` - добавлены проверки
- `post.author.twitterUrl` может быть undefined
- `post.coverImage` может быть undefined

### Lessons
- Теги в revalidateTag() должны точно совпадать (case-sensitive) с тегами в sanityFetch next: { tags }
- Если контент отображается на нескольких страницах (например profile на / и /about), нужно revalidate все эти пути
- Webhook filter в Sanity должен включать ВСЕ типы документов которые отображаются на сайте
- Webhook projection: использовать `"slug": slug.current` (отправляет строку "my-post"), а НЕ `"slug": slug` (отправляет объект {current: "my-post"}). Код должен читать `body.slug` напрямую, не `body.slug.current`. Это официальная рекомендация Sanity docs.

---

## Файлы проекта

### API Routes
- `/app/api/revalidate-path/route.ts` - webhook endpoint для Sanity
- `/app/api/revalidate/route.ts` - резервный endpoint

### Динамические страницы
- `/app/blog/[post]/page.tsx` - страница блог поста
- `/app/projects/[project]/page.tsx` - страница проекта

### Sanity
- `/sanity.config.ts` - конфигурация Sanity Studio
- `/lib/sanity.client.ts` - Sanity client
- `/lib/sanity.query.ts` - GROQ запросы
- `/schemas/` - схемы документов

---

**Последнее обновление:** 2026-02-09
